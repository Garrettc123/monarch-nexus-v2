name: Architecture Gate

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  architecture-compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check Linear Issue Link
        if: github.event_name == 'pull_request'
        run: |
          if ! grep -iE 'linear|api-[0-9]|cadt-[0-9]|infra-[0-9]' <<< "${{ github.event.pull_request.body }}"; then
            echo "❌ PR must reference a Linear issue (e.g., Linear: API-123)"
            exit 1
          fi
          echo "✅ Linear issue found"
      
      - name: Validate HTTPS Only
        run: |
          echo "Checking for hardcoded HTTP endpoints..."
          if grep -r 'http://' services/ --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null | grep -v 'localhost' | grep -v '127.0.0.1' | grep -v '::1'; then
            echo "❌ Found hardcoded HTTP endpoints (non-localhost)"
            exit 1
          fi
          echo "✅ No hardcoded HTTP endpoints"
      
      - name: Detect Secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: Security Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL'
      
      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Check Architecture Checklist
        run: |
          echo "Validating Well-Architected Framework compliance..."
          if [ ! -f .github/WELL_ARCHITECTED_CHECKLIST.json ]; then
            echo "❌ Missing .github/WELL_ARCHITECTED_CHECKLIST.json"
            exit 1
          fi
          echo "✅ Architecture checklist found"
      
      - name: Summary
        if: success()
        run: |
          echo "## ✅ Architecture Gate Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Linear issue referenced" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No hardcoded HTTP endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No secrets detected" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security scan passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Architecture checklist compliant" >> $GITHUB_STEP_SUMMARY

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python Code Style
        run: |
          pip install pylint flake8
          echo "Checking Python code quality..."
          find services -name '*.py' -type f | head -20 | xargs -I {} bash -c 'flake8 {} || true' 2>/dev/null || true
          echo "✅ Code quality check complete"
      
      - name: Check CODEOWNERS
        run: |
          if [ ! -f .github/CODEOWNERS ]; then
            echo "⚠️ Warning: No CODEOWNERS file found"
            exit 0
          fi
          echo "✅ CODEOWNERS file present"
